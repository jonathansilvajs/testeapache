services:
  web:
    build: .
    ports:
      - "8080:80"
    environment:
      GIT_REPO: ${GIT_REPO}
      GIT_REF: ${GIT_REF:-main}
      # DB + init flags
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      RUN_INIT_DB: ${RUN_INIT_DB:-true}
      SOURCE_DB: ${SOURCE_DB:-}
      # Composer
      COMPOSER_UPDATE: ${COMPOSER_UPDATE:-false}
      COMPOSER_DEV: ${COMPOSER_DEV:-false}
      FORCE_COMPOSER_INSTALL: ${FORCE_COMPOSER_INSTALL:-false}
      # Wait DB
      WAIT_FOR_DB: ${WAIT_FOR_DB:-true}
      DB_WAIT_MAX: ${DB_WAIT_MAX:-60}
    volumes:
      - app_code:/var/www/html     # c√≥digo persiste
      - app_state:/var/lib/app     # flags/estado persistem
    restart: unless-stopped

volumes:
  app_code:
  app_state:
