version: "3.9"

services:
  # ---------- JOB: Clonar BD "somniacrm" ----------
  db-cloner:
    image: mysql:8
    container_name: db-cloner-once
    restart: "no"
    environment:
      # Alvo MySQL (externo)
      MYSQL_PWD: ${DB_ADMIN_PASS}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_ADMIN_USER: ${DB_ADMIN_USER}

      # Origem e destino
      CLONE_FROM_DB: ${CLONE_FROM_DB}
      CLONE_TO_DB: ${CLONE_TO_DB}

      # Novo utilizador da BD clonada
      CLONE_DB_USER: ${CLONE_DB_USER}
      CLONE_DB_PASS: ${CLONE_DB_PASS}

      # TLS (opcional): REQUIRED / VERIFY_IDENTITY / PREFERRED / vazio
      MYSQL_SSL_MODE: ${MYSQL_SSL_MODE:-}
    volumes:
      - clone_status:/var/clone-status
    command: >
      sh -lc '
        set -Eeuo pipefail
        LOG=/var/clone-status/clone.log
        OK=/var/clone-status/STATUS_SUCCESS
        FAIL=/var/clone-status/STATUS_FAILED

        # preparar diretório e log
        mkdir -p /var/clone-status || true
        rm -f "$OK" "$FAIL" 2>/dev/null || true
        touch "$LOG" || { echo "STATUS=FAILED (não consegui criar $LOG)"; exit 0; }

        log(){ printf "%s\n" "$@" | tee -a "$LOG" ; }

        ssl=""
        [ -n "${MYSQL_SSL_MODE:-}" ] && ssl="--ssl-mode=${MYSQL_SSL_MODE}"

        log "==== DB CLONE START $(date -u +%Y-%m-%dT%H:%M:%SZ) ===="
        log "Host=${DB_HOST} Port=${DB_PORT} From=${CLONE_FROM_DB} To=${CLONE_TO_DB} UserNew=${CLONE_DB_USER}"

        log ">> Testando conectividade..."
        if ! mysqladmin --protocol=TCP $ssl --connect-timeout=10 -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" ping; then
          log "STATUS=FAILED (sem conectividade)"; : > "$FAIL"; log "==== DB CLONE END ===="; exit 0
        fi

        log ">> Verificando origem com mysqldump --no-data..."
        if ! mysqldump --protocol=TCP $ssl -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" --no-data "${CLONE_FROM_DB}" >/dev/null 2>&1; then
          log "STATUS=FAILED (origem '"'"'${CLONE_FROM_DB}'"'"' não encontrada ou sem acesso)"; : > "$FAIL"; log "==== DB CLONE END ===="; exit 0
        fi

        log ">> Criando BD destino (se não existir)..."
        mysql --protocol=TCP $ssl -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" -e "
          CREATE DATABASE IF NOT EXISTS \`${CLONE_TO_DB}\`
          CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
        "

        log ">> Clonando dados (com rotinas/eventos; se falhar, tenta sem)..."
        set +e
        mysqldump --protocol=TCP $ssl -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" \
          --single-transaction --routines --triggers --events \
          --set-gtid-purged=OFF --column-statistics=0 "${CLONE_FROM_DB}" \
        | mysql --protocol=TCP $ssl -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" "${CLONE_TO_DB}"
        rc=$?
        if [ $rc -ne 0 ]; then
          log "!! Falhou com rotinas/eventos (rc=$rc); tentando sem..."
          mysqldump --protocol=TCP $ssl -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" \
            --single-transaction --triggers \
            --set-gtid-purged=OFF --column-statistics=0 "${CLONE_FROM_DB}" \
          | mysql --protocol=TCP $ssl -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" "${CLONE_TO_DB}"
          rc=$?
        fi
        set -e

        if [ $rc -ne 0 ]; then
          log "STATUS=FAILED dump/restore rc=$rc $(date -u +%Y-%m-%dT%H:%M:%SZ)"; : > "$FAIL"; log "==== DB CLONE END ===="; exit 0
        fi

        log ">> Clone concluído; criando utilizador e permissões..."
        mysql --protocol=TCP $ssl -h "$DB_HOST" -P "$DB_PORT" -u "$DB_ADMIN_USER" -e "
          CREATE USER IF NOT EXISTS \`${CLONE_DB_USER}\`@\`%\` IDENTIFIED BY '${CLONE_DB_PASS}';
          GRANT ALL PRIVILEGES ON \`${CLONE_TO_DB}\`.* TO \`${CLONE_DB_USER}\`@\`%\`;
          FLUSH PRIVILEGES;
        "

        log "STATUS=SUCCESS $(date -u +%Y-%m-%dT%H:%M:%SZ)"; : > "$OK"
        log "==== DB CLONE END ===="
        exit 0
      '

  # ---------- WEB: Apache + PHP ----------
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: php-apache-web
    ports:
      - "8080:80"
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${CLONE_TO_DB}
      DB_USER: ${CLONE_DB_USER}
      DB_PASS: ${CLONE_DB_PASS}
      TZ: ${TZ:-Europe/Lisbon}
    depends_on:
      - db-cloner        # não bloqueia por exit code; o cloner sempre sai 0
    volumes:
      - clone_status:/var/clone-status:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  clone_status:
